{% extends 'culture/base.html' %}
{% load video_filters %}

{% block content %}
<div style="max-width: 900px; margin: 0 auto;">
    <a href="{% url 'performances' %}" class="btn" style="margin-bottom: 1rem;">‚Üê –ù–∞–∑–∞–¥ –∫ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è–º</a>
    
    <div class="card">
        <div class="card-content">
            <h1 style="color: #2c3e50; margin-bottom: 1rem;">{{ performance.title }}</h1>
            
            <div style="background: #ecf0f1; padding: 0.5rem 1rem; border-radius: 4px; display: inline-block; margin-bottom: 1.5rem;">
                üìÖ <strong>–î–∞—Ç–∞:</strong> 
                {% if performance.date %}
                    {{ performance.date|date:"d.m.Y H:i" }}
                {% else %}
                    {{ performance.created_at|date:"d.m.Y H:i" }}
                {% endif %}
            </div>
            
            <!-- –í–∏–¥–µ–æ —Å–µ–∫—Ü–∏—è -->
            <div class="video-wrapper">
                <!-- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º youtube_url (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤ Performance –∏–ª–∏ UserUpload) -->
                {% with url=performance.youtube_url %}
                {% if url %}
                    {% if 'youtube.com' in url or 'youtu.be' in url %}
                        <!-- YouTube –≤–∏–¥–µ–æ -->
                        <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; margin: 2rem 0; background: #000;">
                            <iframe 
                                src="{{ url|youtube_embed }}" 
                                title="YouTube –≤–∏–¥–µ–æ"
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen; payment"
                                allowfullscreen="allowfullscreen"
                                loading="lazy"
                                referrerpolicy="no-referrer-when-downgrade">
                            </iframe>
                        </div>
                    {% elif 'vimeo.com' in url %}
                        <!-- Vimeo –≤–∏–¥–µ–æ -->
                        <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; margin: 2rem 0; background: #000;">
                            <iframe 
                                src="{{ url|vimeo_embed }}" 
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;" 
                                allow="autoplay; fullscreen; picture-in-picture" 
                                allowfullscreen>
                            </iframe>
                        </div>
                    {% elif 'vk.com' in url or 'vkvideo.ru' in url %}
                        <!-- –í–ö–æ–Ω—Ç–∞–∫—Ç–µ –≤–∏–¥–µ–æ -->
                        <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; margin: 2rem 0; background: #000;">
                            <iframe 
                                src="{{ url|vk_embed }}" 
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;" 
                                allow="autoplay; fullscreen; picture-in-picture" 
                                allowfullscreen>
                            </iframe>
                        </div>
                    {% else %}
                        <!-- –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –≤–∏–¥–µ–æ -->
                        <div style="text-align: center; padding: 3rem; background: #f8f9fa; border-radius: 8px;">
                            <p>‚ö†Ô∏è –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –≤–∏–¥–µ–æ</p>
                            <p style="font-size: 0.9rem; color: #666;">URL: {{ url }}</p>
                            <p style="font-size: 0.85rem; color: #999; margin-top: 1rem;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã: YouTube, Vimeo, –í–ö–æ–Ω—Ç–∞–∫—Ç–µ</p>
                        </div>
                    {% endif %}
                {% elif performance.video_file %}
                    <!-- Performance - –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ -->
                    <div style="margin: 2rem 0;">
                        <div style="position: relative; border-radius: 8px; overflow: hidden; background: #000;">
                            <video 
                                id="video-player"
                                controls 
                                style="width: 100%; display: block;"
                                playsinline
                                preload="metadata"
                            >
                                <source src="{{ performance.video_file.url }}" type="{{ performance.video_file|video_mime_type }}">
                                <source src="{{ performance.video_file.url }}" type="video/mp4">
                                <source src="{{ performance.video_file.url }}" type="video/webm">
                                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤–∏–¥–µ–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–∞—á–∞–π—Ç–µ –≤–∏–¥–µ–æ: <a href="{{ performance.video_file.url }}">—Å–∫–∞—á–∞—Ç—å</a>
                            </video>
                        </div>
                    </div>
                {% elif performance.video %}
                    <!-- UserUpload - –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ -->
                    <div style="margin: 2rem 0;">
                        <div style="position: relative; border-radius: 8px; overflow: hidden; background: #000;">
                            <video 
                                id="video-player"
                                controls 
                                style="width: 100%; display: block;"
                                playsinline
                                preload="metadata"
                            >
                                <source src="{{ performance.video.url }}" type="{{ performance.video|video_mime_type }}">
                                <source src="{{ performance.video.url }}" type="video/mp4">
                                <source src="{{ performance.video.url }}" type="video/webm">
                                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤–∏–¥–µ–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–∞—á–∞–π—Ç–µ –≤–∏–¥–µ–æ: <a href="{{ performance.video.url }}">—Å–∫–∞—á–∞—Ç—å</a>
                            </video>
                        </div>
                    </div>
                {% else %}
                    <div style="text-align: center; padding: 3rem; background: #f8f9fa; border-radius: 8px;">
                        <p>–í–∏–¥–µ–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</p>
                    </div>
                {% endif %}
                {% endwith %}
            </div>
            
            <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
            <div style="margin: 2rem 0;">
                <h3 style="color: #2c3e50; margin-bottom: 1rem;">–û–ø–∏—Å–∞–Ω–∏–µ</h3>
                <div style="line-height: 1.8; font-size: 1.1rem;">
                    {{ performance.description|linebreaks }}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // –£–ª—É—á—à–µ–Ω–Ω—ã–π –≤–∏–¥–µ–æ–ø–ª–µ–µ—Ä
    document.addEventListener('DOMContentLoaded', function() {
        const videoPlayer = document.getElementById('video-player');
        
        if (videoPlayer) {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏–¥–µ–æ–ø–ª–µ–µ—Ä–∞
            videoPlayer.addEventListener('loadedmetadata', function() {
                console.log('–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:', videoPlayer.duration);
            });
            
            videoPlayer.addEventListener('error', function() {
                console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ');
                
                // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                const container = videoPlayer.parentElement;
                const errorMsg = document.createElement('div');
                errorMsg.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0,0,0,0.9);
                    color: white;
                    padding: 2rem;
                    border-radius: 8px;
                    text-align: center;
                    z-index: 100;
                    width: 80%;
                    max-width: 500px;
                `;
                errorMsg.innerHTML = `
                    <h4 style="margin-bottom: 1rem;">–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ</h4>
                    <p style="margin-bottom: 1rem;">
                        –í–æ–∑–º–æ–∂–Ω–æ, —Ñ–æ—Ä–º–∞—Ç –≤–∏–¥–µ–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.
                    </p>
                    <p style="font-size: 0.9rem; color: #ccc;">
                        –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–∏–¥–µ–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ MP4 —Å –∫–æ–¥–µ–∫–∞–º–∏ H.264 (–≤–∏–¥–µ–æ) –∏ AAC (–∞—É–¥–∏–æ).
                    </p>
                `;
                container.appendChild(errorMsg);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
            const container = videoPlayer.parentElement;
            const fullscreenBtn = document.createElement('button');
            fullscreenBtn.innerHTML = '‚õ∂';
            fullscreenBtn.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                background: rgba(0,0,0,0.7);
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 4px;
                cursor: pointer;
                z-index: 10;
                font-size: 16px;
            `;
            fullscreenBtn.addEventListener('click', function() {
                if (videoPlayer.requestFullscreen) {
                    videoPlayer.requestFullscreen();
                } else if (videoPlayer.webkitRequestFullscreen) {
                    videoPlayer.webkitRequestFullscreen();
                } else if (videoPlayer.msRequestFullscreen) {
                    videoPlayer.msRequestFullscreen();
                }
            });
            container.appendChild(fullscreenBtn);
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
            document.addEventListener('fullscreenchange', function() {
                if (!document.fullscreenElement) {
                    fullscreenBtn.style.display = 'block';
                }
            });
        }
    });
</script>
{% endblock %}