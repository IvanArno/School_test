{% extends 'culture/base.html' %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <h1 class="section-title">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</h1>
    
    <div class="card">
        <div class="card-content">
            <div id="upload-message" style="display: none; padding: 1rem; margin: 1rem 0; border-radius: 4px;"></div>
            
            <form id="upload-form" enctype="multipart/form-data">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞ *</label>
                    <select id="upload-type" name="type" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="photo">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</option>
                        <option value="video">–í–∏–¥–µ–æ</option>
                        <option value="poster">–ê—Ñ–∏—à–∞</option>
                        <option value="award">–ù–∞–≥—Ä–∞–¥–∞</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                    <input type="text" name="title" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea name="description" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>
                
                <!-- –ü–æ–ª—è –¥–ª—è —Ñ–∞–π–ª–æ–≤ -->
                <div id="photo-fields" style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ *</label>
                    <input type="file" id="photo-image" name="photo_image" accept="image/*" style="width: 100%; padding: 0.5rem;">
                    <small style="color: #666;">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB</small>
                </div>
                
                <div id="video-fields" style="margin-bottom: 1.5rem; display: none;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">–í–∏–¥–µ–æ—Ñ–∞–π–ª</label>
                    <input type="file" id="video-video" name="video" accept="video/*" style="width: 100%; padding: 0.5rem;">
                    <small style="color: #666;">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 50MB</small>
                    
                    <div style="margin-top: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">–ò–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ</label>
                        <input type="text" name="youtube_url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ YouTube, –í–ö–æ–Ω—Ç–∞–∫—Ç–µ –∏–ª–∏ Vimeo" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <small style="color: #666;">–ü—Ä–∏–º–µ—Ä—ã: https://youtu.be/..., https://vk.com/video-..., https://vkvideo.ru/video-... –∏–ª–∏ https://vimeo.com/...</small>
                    </div>
                </div>
                
                <div id="poster-fields" style="margin-bottom: 1.5rem; display: none;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">–ê—Ñ–∏—à–∞ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ) *</label>
                    <input type="file" id="poster-image" name="poster_image" accept="image/*" style="width: 100%; padding: 0.5rem;">
                    <small style="color: #666;">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB</small>
                </div>

                <div id="award-fields" style="margin-bottom: 1.5rem; display: none;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">–§–æ—Ç–æ –Ω–∞–≥—Ä–∞–¥—ã *</label>
                    <input type="file" id="award-image" name="award_image" accept="image/*" style="width: 100%; padding: 0.5rem;">
                    <small style="color: #666;">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB</small>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                <div style="text-align: center;">
                    <button type="submit" id="submit-btn" style="background: #4caf50; color: white; border: none; padding: 0.75rem 2rem; border-radius: 4px; font-size: 1rem; cursor: pointer; display: inline-flex; align-items: center;">
                        <span id="btn-text">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ–π—á–∞—Å</span>
                        <span id="loading-spinner" style="display: none; margin-left: 0.5rem;">‚è≥</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div style="margin-top: 2rem; padding: 1.5rem; background: #e8f5e9; border-radius: 8px;">
        <h3 style="color: #2c3e50; margin-bottom: 1rem;">‚ú® –ú–∞—Ç–µ—Ä–∏–∞–ª –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞ —Å–∞–π—Ç–µ —Å—Ä–∞–∑—É!</h3>
        <p>–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞—à –º–∞—Ç–µ—Ä–∏–∞–ª:</p>
        <ul style="list-style: none; padding: 0;">
            <li style="margin-bottom: 0.5rem; padding-left: 1.5rem; position: relative;">
                <span style="position: absolute; left: 0;">‚úÖ</span>
                –ë—É–¥–µ—Ç —Å—Ä–∞–∑—É –≤–∏–¥–µ–Ω –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            </li>
            <li style="margin-bottom: 0.5rem; padding-left: 1.5rem; position: relative;">
                <span style="position: absolute; left: 0;">‚úÖ</span>
                –ü–æ–ø–∞–¥–µ—Ç –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª (–ê—Ñ–∏—à–∏/–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è/–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏)
            </li>
            <li style="margin-bottom: 0.5rem; padding-left: 1.5rem; position: relative;">
                <span style="position: absolute; left: 0;">‚úÖ</span>
                –ë—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º —Å–∞–π—Ç–∞
            </li>
        </ul>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('upload-form');
        const uploadType = document.getElementById('upload-type');
        const photoFields = document.getElementById('photo-fields');
        const videoFields = document.getElementById('video-fields');
        const posterFields = document.getElementById('poster-fields');
        const awardFields = document.getElementById('award-fields');
        const submitBtn = document.getElementById('submit-btn');
        const btnText = document.getElementById('btn-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const uploadMessage = document.getElementById('upload-message');
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        uploadType.addEventListener('change', function() {
            photoFields.style.display = 'none';
            videoFields.style.display = 'none';
            posterFields.style.display = 'none';
            awardFields.style.display = 'none';
            
            if (this.value === 'photo') {
                photoFields.style.display = 'block';
            } else if (this.value === 'video') {
                videoFields.style.display = 'block';
            } else if (this.value === 'poster') {
                posterFields.style.display = 'block';
            } else if (this.value === 'award') {
                awardFields.style.display = 'block';
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
            const uploadType = document.getElementById('upload-type').value;
            const titleInput = form.querySelector('input[name="title"]');
            const photoImageInput = document.getElementById('photo-image');
            const posterImageInput = document.getElementById('poster-image');
            const awardImageInput = document.getElementById('award-image');
            const videoInput = document.getElementById('video-video');
            const youtubeUrlInput = form.querySelector('input[name="youtube_url"]');
            
            console.log('Form submission:', {
                uploadType,
                title: titleInput.value,
                photoFile: photoImageInput ? photoImageInput.files.length : 0,
                posterFile: posterImageInput ? posterImageInput.files.length : 0,
                awardFile: awardImageInput ? awardImageInput.files.length : 0,
                videoFile: videoInput ? videoInput.files.length : 0,
                videoUrl: youtubeUrlInput ? youtubeUrlInput.value : ''
            });
            
            if (!titleInput.value.trim()) {
                uploadMessage.style.backgroundColor = '#ffcdd2';
                uploadMessage.style.color = '#c62828';
                uploadMessage.style.border = '1px solid #ef9a9a';
                uploadMessage.innerHTML = '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞';
                uploadMessage.style.display = 'block';
                return;
            }
            
            if (uploadType === 'photo' || uploadType === 'poster' || uploadType === 'award') {
                let imageInput = null;
                if (uploadType === 'photo') {
                    imageInput = photoImageInput;
                } else if (uploadType === 'poster') {
                    imageInput = posterImageInput;
                } else if (uploadType === 'award') {
                    imageInput = awardImageInput;
                }
                
                if (!imageInput || !imageInput.files.length) {
                    uploadMessage.style.backgroundColor = '#ffcdd2';
                    uploadMessage.style.color = '#c62828';
                    uploadMessage.style.border = '1px solid #ef9a9a';
                    uploadMessage.innerHTML = '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
                    uploadMessage.style.display = 'block';
                    return;
                }
            } else if (uploadType === 'video') {
                // –î–ª—è –≤–∏–¥–µ–æ –Ω—É–∂–Ω–æ –ª–∏–±–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª, –ª–∏–±–æ URL
                const hasVideoFile = videoInput && videoInput.files && videoInput.files.length > 0;
                const hasVideoUrl = youtubeUrlInput && youtubeUrlInput.value.trim();
                
                console.log('Video validation:', { hasVideoFile, hasVideoUrl });
                
                if (!hasVideoFile && !hasVideoUrl) {
                    uploadMessage.style.backgroundColor = '#ffcdd2';
                    uploadMessage.style.color = '#c62828';
                    uploadMessage.style.border = '1px solid #ef9a9a';
                    uploadMessage.innerHTML = '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ';
                    uploadMessage.style.display = 'block';
                    return;
                }
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è URL –µ—Å–ª–∏ –æ–Ω –∑–∞–ø–æ–ª–Ω–µ–Ω
                if (hasVideoUrl) {
                    const urlValue = youtubeUrlInput.value.trim();
                    const validVideoPatterns = [
                        'youtube.com',
                        'youtu.be',
                        'vk.com',
                        'vkvideo.ru',
                        'vimeo.com'
                    ];
                    
                    const isValidUrl = validVideoPatterns.some(pattern => urlValue.includes(pattern));
                    
                    if (!isValidUrl) {
                        uploadMessage.style.backgroundColor = '#ffcdd2';
                        uploadMessage.style.color = '#c62828';
                        uploadMessage.style.border = '1px solid #ef9a9a';
                        uploadMessage.innerHTML = '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ YouTube, –í–ö–æ–Ω—Ç–∞–∫—Ç–µ –∏–ª–∏ Vimeo';
                        uploadMessage.style.display = 'block';
                        return;
                    }
                }
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            submitBtn.disabled = true;
            btnText.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...';
            loadingSpinner.style.display = 'inline';
            uploadMessage.style.display = 'none';
            
            // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–æ–≤
            const formData = new FormData(form);
            
            console.log('FormData contents:');
            for (let [key, value] of formData.entries()) {
                if (key !== 'image' && key !== 'video') {
                    console.log(key, value);
                }
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            fetch('{% url "upload_file" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                submitBtn.disabled = false;
                loadingSpinner.style.display = 'none';
                
                if (data.success) {
                    uploadMessage.style.backgroundColor = '#c8e6c9';
                    uploadMessage.style.color = '#2e7d32';
                    uploadMessage.style.border = '1px solid #81c784';
                    uploadMessage.innerHTML = '‚úÖ ' + data.message;
                    uploadMessage.style.display = 'block';
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    form.reset();
                    btnText.textContent = 'üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ–π—á–∞—Å';
                    
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(function() {
                        window.location.href = '{% url "home" %}';
                    }, 2000);
                } else {
                    uploadMessage.style.backgroundColor = '#ffcdd2';
                    uploadMessage.style.color = '#c62828';
                    uploadMessage.style.border = '1px solid #ef9a9a';
                    uploadMessage.innerHTML = '‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                    uploadMessage.style.display = 'block';
                    btnText.textContent = 'üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ–π—á–∞—Å';
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                submitBtn.disabled = false;
                loadingSpinner.style.display = 'none';
                uploadMessage.style.backgroundColor = '#ffcdd2';
                uploadMessage.style.color = '#c62828';
                uploadMessage.style.border = '1px solid #ef9a9a';
                uploadMessage.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ' + error.message;
                uploadMessage.style.display = 'block';
                btnText.textContent = 'üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ–π—á–∞—Å';
            });
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}